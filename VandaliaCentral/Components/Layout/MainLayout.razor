@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@namespace VandaliaCentral.Components.Layout
@using VandaliaCentral.Services
@inject PdfService PdfService
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider



<div>
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-vandalia-secondary px-4" style="height: 80px; overflow: hidden;">
        
        <div class="d-flex w-100 align-items-center justify-content-between">
            <!-- Brand -->
            <a class="navbar-brand" href="/">
                <img src=".\VR_black.png" width="151" height="47" class="align-top mb-2 mt-1" />
            </a>
            
            <!--Mobile responsive hamburger menu button-->
            <button class="btn btn-light d-lg-none me-2" @onclick="ToggleSidebar">
                <i class="bi bi-list"></i> <!-- or use "☰" if not using Bootstrap icons -->
            </button>
            <!--Mobile responsive hamburger menu button-->

            @if (IsUploader)
            {
                <div class="d-flex align-items-center gap-3">
                    @if (!string.IsNullOrEmpty(uploadStatus))
                    {
                        <div class="btn-success rounded px-2 py-1">
                            @uploadStatus
                        </div>
                    }

                    <label class="btn btn-primary mmbtn custom-upload-button text-nowrap " style="max-width: 200px;">
                        Upload Monday Minute
                        <InputFile OnChange="HandleFileUpload" accept=".pdf" class="d-none" />
                    </label>
                </div>
            }
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main-content-wrapper d-flex">
        <!-- Sidebar -->
        <div class=@SidebarCssClass id="sidebarMenu">        
            <CascadingValue Value="(Action)CloseSidebar">
                <NavMenu></NavMenu>
            </CascadingValue>
        </div>

        <!-- Content -->
        <div class="main-content flex-grow-1" style="background: #F5F5F5;">
            @Body
        </div>
    </div>
</div>

@code {
    private string SidebarCssClass => showSidebar ? "vandalia-sidebar show d-lg-block" : "vandalia-sidebar d-lg-block";
    private bool showSidebar = false;
    private string? uploadStatus;
    private string? statusClass;
    private bool IsUploader = true;

    private void ToggleSidebar()
    {
        showSidebar = !showSidebar;
    }

    private void CloseSidebar()
    {
        showSidebar = false;
    }


    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if (file is null || !file.Name.EndsWith(".pdf"))
        {
            uploadStatus = "Please select a valid PDF file.";

            return;
        }

        try
        {
            uploadStatus = "Uploading...";

            await PdfService.UploadPdfAsync("mondayminute", file);
            uploadStatus = "Upload successful!";
           
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                uploadStatus = null;
                
                await InvokeAsync(StateHasChanged); // Tell Blazor to re-render
            });
            
        }
        catch (Exception ex)
        {
            uploadStatus = $"Upload failed: {ex.Message}";
        }
    }
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Check if user is in the correct Entra ID group by claim
        IsUploader = user.Claims.Any(c =>
            c.Type == "groups" && c.Value == "b3a0f732-a5f2-4c28-a005-61c901b21096");
    }
    
}





